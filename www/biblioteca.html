<?php

$user ='root';
$pass='';
$banco='biblioteca';
$sever='localhost';
$conn=new mysqli($sever,$user,$pass,$banco);
if(!$conn){
	echo 'Erro de conexão:'.$conn->error;
}

functiom Login($email,$senha,$tipo){
	$sql = 'SELECT * FROM usuario
	WHERE email = "'.$EMAIL.'" AND senha = "'.$senha'"';
	$res = $GLOBLAS['conn']->query($sql);
	if($res->num_rows > 0){
		$retorno['error'] = false;
		$user = $res-> fetch_object();
		$retorno['dados'] = $user;
	}else{
      $retorno['erro'] = true;
	}
	if($tipo=="json")
		return json_encode($retorno);
	else 
		return $retorno;
	}

function CadastrarUsuario($rm,$nome,$email,$senha){
	$sql. = 'INSERT INTO usuario (rm,nome,email,senha,adm) VALUES (';
	$sql. =$rm.',"'.$nome.'","'.$email.'","'.$senha.'","'.$adm.'")';
	$destino = 'fotos/'.$rm
    !is_dir($destino){
    	mkdir($destino,0777);
    }
    $res = $GLOBALS['conn']->query($sql);
    if($res)
    	echo "Adm cadastrado com sucesso!";
    else
    	echo "Erro ao cadastrar";

}

function ExcluirUsuario($rm){
	$sql = 'DELETE FROM usuario WHERE rm = '.$rm;
	$res = $GLOBALS['conn']->query($sql);
	if($res)
		echo "Excluido com sucesso!!";
	else
		echo "Erro ao excluir";
}

function AtualizarUsuario($rm,$nome,$nasc,$gen,$tel){
	$sql = 'UPDATE usuario SET nome = "'.$nome.'",
	dt_nascimento = "'.$nasc.'", genero = "'.$gen.'",
	telefone = "'.$tel.'"  WHERE rm = '.$rm;
	$res = GLOBALS[$conn]->query($sql);
	if($res)
		echo "Atualizado com sucesso!!";
	else
		echo"Erro ao cadastrar";

}


function TrocarFoto($rm,$foto){
	$destino = 'usuario/fotos'.$rm.'/'.$foto['name'];
	if(move_uploaded_file($foto['tmp_name'], $destino)){
		$sql = 'SELECT * FROM usuario WHERE rm = '.$rm;
		$res = $GLOBALS['conn']->query($sql);
		$user = $res->fetch_array();
		if($res){
			echo "Atualizado com sucesso";
		}else{
			echo "Erro ao atualizar foto";
		}
	}
}

function TrocarSenha($rm){
	$nova_senha = "";
	$msg = "Sua nova senha: ".$nova_senha;
	$sql = 'SELECT * FROM usuario WHERE rm = '.$rm;
	$res =  $GLOBALS['conn']->query($sql);
	$user = $res->fetch_array();
	if(mail($user['email'],"Biblioteca[nova senha]",$msg)){
		$sql = 'UPDATE usuario SET senha ="'.$nova_senha.'" WHERE rm = '.$rm;
		$res = $GLOBALS['conn']->query($sql);
		if($res){
			echo "Nova senha encaminhada para seu email!";
		}else{
			echo "Erro ao trocar senha.Tente novamente";
		}
        
	}
}
function CadastrarGenero($nome){
	$sql ='INSERT INTO genero VALUES(null,"'.$nome.'")';
	$res = $GLOBALS['conn']->query($sql);
	if($res){
		echo "Genero Cadastrado";
	}else{
		echo"Erro ao Cadastrar";

	}

	}
	function ExcluirSenha($cd){
		$sql = 'DELETE FROM  genero WHERE cd = '.cd;
		$res = $GLOBALS['conn']->query($sql);
		if($res){
			echo"Genero excluido";
		}else{
			echo"Erro ao excluir, verifique se há livros utilizandos";

		}
	}

